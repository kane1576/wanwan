<!DOCTYPE html><!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS Web App 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="記帳簿">
    <title>個人會計記帳系統 V2023</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 修正: 升級 Babel 到最新版以支援現代語法 -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent; /* 移除 iOS 點擊高亮 */
        }
        /* 優化 iOS 滾動體驗 */
        .overflow-y-auto { -webkit-overflow-scrolling: touch; }
        .tab-active { border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 600; } /* Active tab red */
        .tab-inactive { color: #6b7280; }
        
        /* iPhone X+ 底部安全區域 */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* 自定義顏色類別 (符合用戶需求) */
        .text-asset { color: #dc2626; } /* 紅色 */
        .bg-asset { background-color: #fef2f2; }
        .text-income { color: #dc2626; } /* 紅色 */
        .bg-income { background-color: #fef2f2; }
        .text-liab { color: #16a34a; } /* 綠色 */
        .bg-liab { background-color: #f0fdf4; }
        .text-expense { color: #16a34a; } /* 綠色 */
        .bg-expense { background-color: #f0fdf4; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        
        // --- 圖標組件 ---
        const Icons = {
            BookOpen: () => <i data-lucide="book-open" className="w-5 h-5"></i>,
            PieChart: () => <i data-lucide="pie-chart" className="w-5 h-5"></i>,
            Settings: () => <i data-lucide="settings" className="w-5 h-5"></i>,
            List: () => <i data-lucide="list" className="w-5 h-5"></i>,
            Plus: () => <i data-lucide="plus" className="w-4 h-4"></i>,
            Trash: () => <i data-lucide="trash-2" className="w-4 h-4"></i>,
            ArrowRight: () => <i data-lucide="arrow-right" className="w-4 h-4 inline mx-2"></i>,
            Save: () => <i data-lucide="save" className="w-4 h-4"></i>,
            X: () => <i data-lucide="x" className="w-4 h-4"></i>,
            Filter: () => <i data-lucide="filter" className="w-3 h-3"></i>,
            Download: () => <i data-lucide="download" className="w-4 h-4"></i>,
            Upload: () => <i data-lucide="upload" className="w-4 h-4"></i>,
            FileText: () => <i data-lucide="file-text" className="w-4 h-4"></i>,
            AlertTriangle: () => <i data-lucide="alert-triangle" className="w-4 h-4"></i>,
            Edit: () => <i data-lucide="edit-2" className="w-4 h-4"></i>,
            Check: () => <i data-lucide="check" className="w-4 h-4"></i>,
            FilePlus: () => <i data-lucide="file-plus" className="w-4 h-4"></i>
        };

        // --- 預設資料 (若無存檔時使用) ---
        const DEFAULT_CATEGORIES = {
            ASSETS: [
                "現金-錢包-台幣", "現金-Line-台幣", "現金-悠遊卡-台新", "現金-悠遊卡-花旗",
                "銀行存款-渣打-台幣", "銀行存款-台新-台幣", "銀行存款-國泰-台幣", "銀行存款-國泰-外幣", "銀行存款-元大-台幣",
                "應收帳款-公司-美甲社", "應收帳款-私人-媽媽", "應收帳款-私人-瑋",
                "股票投資-台股-成本", "股票投資-台股-評價",
                "儲蓄險-祿美利利-外幣", "儲蓄險-雋美年年-外幣", "儲蓄險-樂事年年-台幣", "儲蓄險-祿美佳-外幣",
                "預付款項-健身教練", "預付款項-羽球場", "預付款項-麥當勞"
            ],
            LIABILITIES: [
                "信用卡-台新-Richart", "信用卡-國泰-蝦皮/koko", "信用卡-花旗-現金回饋", "信用卡-富邦-momo", "信用卡-元大-鑽金",
                "應付帳款-Brian", "應付帳款-其他", "未實現-台股-評價"
            ],
            INCOME: [
                "薪資", "利息收入", "股利收入", "獎金", "投資收益", "其他收入"
            ],
            EXPENSES: [
                "租金支出-房租管理費", "租金支出-水費", "租金支出-電費",
                "伙食費", "保險費", "外在支出-彩妝保養", "外在支出-服裝飾品",
                "交際費", "交通費", "電話費", "生活用品", "運動健康",
                "旅遊-機加酒", "旅遊-伙食", "旅遊-交通", "旅遊-購物&其他",
                "醫療費", "雜費"
            ]
        };

        // 根據 BS_20230103.csv 設定完整期初餘額
        const DEFAULT_OPENING_BALANCES = {
            // 資產 (Assets)
            "現金-錢包-台幣": 1260,
            "現金-Line-台幣": 6129,
            "現金-悠遊卡-台新": 335,
            "現金-悠遊卡-花旗": 493,
            "銀行存款-渣打-台幣": 112247,
            "銀行存款-台新-台幣": 0,
            "銀行存款-國泰-台幣": 0,
            "銀行存款-國泰-外幣": 0,
            "銀行存款-元大-台幣": 0,
            "應收帳款-公司-美甲社": 0,
            "應收帳款-私人-媽媽": 0,
            "應收帳款-私人-瑋": 0,
            "股票投資-台股-成本": 0,
            "股票投資-台股-評價": 0,
            "儲蓄險-祿美利利-外幣": 0,
            "儲蓄險-雋美年年-外幣": 0,
            "儲蓄險-樂事年年-台幣": 0,
            "儲蓄險-祿美佳-外幣": 0,
            "預付款項-健身教練": 0,
            "預付款項-羽球場": 0,
            "預付款項-麥當勞": 0,

            // 負債 (Liabilities) - 負數表示
            "信用卡-台新-Richart": -7506,
            "信用卡-國泰-蝦皮/koko": -69,
            "信用卡-花旗-現金回饋": -29610,
            "信用卡-富邦-momo": -21168,
            "信用卡-元大-鑽金": 0,
            "應付帳款-Brian": 0,
            "應付帳款-其他": 0,
            "未實現-台股-評價": 0
        };

        // --- LocalStorage 存取輔助 ---
        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        // --- 主要應用程式組件 ---
        const App = () => {
            // State (改用 useStickyState 自動存檔)
            const [activeTab, setActiveTab] = useState("journal"); 
            const [categories, setCategories] = useStickyState(DEFAULT_CATEGORIES, "my_app_categories_v2");
            const [entries, setEntries] = useStickyState([], "my_app_entries_v2");
            const [openingBalances, setOpeningBalances] = useStickyState(DEFAULT_OPENING_BALANCES, "my_app_opening_balances_v2");
            
            // UI State
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            const [drAccount, setDrAccount] = useState("");
            const [crAccount, setCrAccount] = useState(""); 
            const [amount, setAmount] = useState("");
            const [description, setDescription] = useState("");
            const [isCsvUtf8, setIsCsvUtf8] = useState(true); // 新增：CSV 編碼選擇
            
            // 編輯模式 State
            const [editingId, setEditingId] = useState(null);
            const [editDescription, setEditDescription] = useState("");
            const [editAmount, setEditAmount] = useState("");
            
            // 新增：交易列表篩選狀態
            const [filterAccount, setFilterAccount] = useState("");

            const [newAccountInputs, setNewAccountInputs] = useState({
                ASSETS: "", LIABILITIES: "", INCOME: "", EXPENSES: ""
            });

            // 檔案上傳 ref
            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [activeTab, categories, entries, filterAccount, editingId]);

            // --- 輔助函式 ---
            const allAccounts = useMemo(() => {
                return [
                    ...(categories.ASSETS || []),
                    ...(categories.LIABILITIES || []),
                    ...(categories.INCOME || []),
                    ...(categories.EXPENSES || [])
                ];
            }, [categories]);

            const getAccountType = (accountName) => {
                if (categories.ASSETS.includes(accountName)) return '資產';
                if (categories.LIABILITIES.includes(accountName)) return '負債';
                if (categories.INCOME.includes(accountName)) return '收入';
                if (categories.EXPENSES.includes(accountName)) return '支出';
                return '其他';
            };

            // 根據類型返回顏色樣式 (符合使用者需求：紅=資產/收入，綠=負債/支出)
            const getAccountStyle = (accountName) => {
                const type = getAccountType(accountName);
                switch (type) {
                    case '資產': return 'text-asset bg-asset'; // 紅
                    case '收入': return 'text-income bg-income'; // 紅
                    case '負債': return 'text-liab bg-liab'; // 綠
                    case '支出': return 'text-expense bg-expense'; // 綠
                    default: return 'text-gray-600 bg-gray-100';
                }
            };
            
            const getAmountStyle = (val) => {
                // 正數顯示黑/紅，負數顯示綠? 這裡我們保持資產負債表的邏輯
                // 但為了報表清晰，我們統一：
                // 正數 (Assets, Expenses) 
                // 負數 (Liab, Income)
                return val < 0 ? 'text-green-600' : 'text-red-600';
            };

            // --- 邏輯處理 ---
            const handleAddEntry = (e) => {
                e.preventDefault();
                if (!drAccount || !crAccount || !amount) {
                    alert("請完整填寫交易資訊");
                    return;
                }
                const numAmount = parseFloat(amount);
                const id = Date.now();
                
                // 借方分錄 (通常是正數)
                const drEntry = { id: id, date: newDate, account: drAccount, amount: numAmount, description: description };
                // 貸方分錄 (通常是負數)
                const crEntry = { id: id + 1, date: newDate, account: crAccount, amount: -numAmount, description: description };

                setEntries([drEntry, crEntry, ...entries]);
                setAmount("");
                setDescription("");
                // alert("已儲存！"); // 移除 alert 讓體驗更順暢
            };

            const handleDeleteEntry = (id) => {
                if(confirm("確定要刪除這筆分錄嗎？建議同時檢查是否有對應的借/貸分錄。")) {
                    setEntries(entries.filter(e => e.id !== id));
                }
            };

            // --- 編輯功能邏輯 ---
            const startEditing = (entry) => {
                setEditingId(entry.id);
                setEditDescription(entry.description || "");
                // 顯示金額絕對值，方便編輯
                setEditAmount(Math.abs(entry.amount));
            };

            const cancelEditing = () => {
                setEditingId(null);
                setEditDescription("");
                setEditAmount("");
            };

            const saveEditing = (id) => {
                const targetEntry = entries.find(e => e.id === id);
                if (!targetEntry) return;

                const newAmt = parseFloat(editAmount);
                // 保持原本的正負號
                const finalAmt = targetEntry.amount >= 0 ? newAmt : -newAmt;

                // 嘗試尋找對應分錄 (同一時間建立，金額相反，摘要相同)
                // 這是一個簡單的 heuristic，不保證 100% 準確，但對單機版足夠好用
                // 邏輯：ID 差 1 (因為建立時是 id, id+1)，且金額互為相反數
                let partnerId = null;
                const partnerCandidates = entries.filter(e => 
                    Math.abs(e.id - id) <= 5 && // ID 接近
                    e.date === targetEntry.date && 
                    e.amount === -targetEntry.amount
                );
                
                if (partnerCandidates.length === 1) {
                    partnerId = partnerCandidates[0].id;
                }

                setEntries(prevEntries => prevEntries.map(e => {
                    // 更新目標分錄
                    if (e.id === id) {
                        return { ...e, description: editDescription, amount: finalAmt };
                    }
                    // 如果找到對應分錄，且使用者修改了金額，我們嘗試連動更新
                    if (e.id === partnerId && finalAmt !== targetEntry.amount) {
                        // 對應分錄金額應為相反數
                        return { ...e, description: editDescription, amount: -finalAmt };
                    }
                    return e;
                }));

                setEditingId(null);
            };


            const handleAddAccount = (categoryKey) => {
                const name = newAccountInputs[categoryKey].trim();
                if (!name) return;
                if (allAccounts.includes(name)) {
                    alert("此科目已存在");
                    return;
                }
                setCategories(prev => ({
                    ...prev,
                    [categoryKey]: [...prev[categoryKey], name]
                }));
                setNewAccountInputs(prev => ({ ...prev, [categoryKey]: "" }));
            };

            const handleDeleteAccount = (categoryKey, name) => {
                 if (entries.some(e => e.account === name) || (openingBalances[name] && openingBalances[name] !== 0)) {
                    if (!confirm(`科目「${name}」已被使用，刪除可能導致報表異常。確定要刪除嗎？`)) return;
                } else {
                    if (!confirm(`確定要刪除「${name}」嗎？`)) return;
                }
                setCategories(prev => ({
                    ...prev,
                    [categoryKey]: prev[categoryKey].filter(item => item !== name)
                }));
            };

            // --- 匯出功能 ---
            const exportToJSON = () => {
                const data = {
                    categories,
                    entries,
                    openingBalances,
                    exportDate: new Date().toISOString(),
                    appVersion: "2023_V2"
                };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `記帳簿備份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const exportToCSV = () => {
                const bom = "\uFEFF";
                const headers = "ID,日期,會計科目,金額,摘要\n";
                const rows = entries.map(e => 
                    `${e.id},${e.date},${e.account},${e.amount},"${e.description || ''}"`
                ).join("\n");
                const csvContent = bom + headers + rows;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `記帳明細_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // --- 匯入功能 ---
            const handleImportJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.categories || !importedData.entries || !importedData.openingBalances) {
                            throw new Error("格式錯誤：找不到必要的資料欄位");
                        }
                        if(confirm(`準備匯入備份檔，這將會：\n1. 覆蓋目前的設定\n2. 載入 ${importedData.entries.length} 筆交易紀錄\n\n確定要繼續嗎？`)) {
                            setCategories(importedData.categories);
                            setEntries(importedData.entries);
                            setOpeningBalances(importedData.openingBalances);
                            alert("匯入成功！資料已更新。");
                        }
                    } catch (error) {
                        alert("匯入失敗：檔案格式錯誤或損毀。\n" + error.message);
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            // --- CSV 匯入功能 (新增) ---
            const handleImportCSV = (event) => {
                const files = event.target.files;
                if (!files || files.length === 0) return;

                // 累計匯入的紀錄
                let newEntries = [];
                let processedCount = 0;

                // 處理單個檔案
                const processFile = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const text = e.target.result;
                            const lines = text.split(/\r\n|\n/);
                            const parsed = [];
                            
                            // 簡單的 CSV 解析 (假設標頭在第一行)
                            // 標頭: 日期,會計科目,金額,摘要...
                            // 索引: 0, 1, 2, 3
                            
                            let isHeader = true;
                            lines.forEach((line) => {
                                if (!line.trim()) return;
                                
                                // 處理逗號分隔，忽略引號內的逗號 (簡單版)
                                const row = line.split(',');
                                
                                if (isHeader) {
                                    // 檢查是否為標頭行，如果是則跳過
                                    if (row[0].includes('日期') || row[1].includes('會計科目')) {
                                        isHeader = false;
                                        return;
                                    }
                                    isHeader = false; // 如果第一行不是標頭，直接處理
                                }

                                // 安全檢查：至少要有日期、科目、金額
                                if (row.length < 3) return;

                                const date = row[0].trim();
                                const account = row[1].trim();
                                const amountStr = row[2].trim();
                                const desc = row[3] ? row[3].trim() : "";

                                // 驗證日期格式 YYYY-MM-DD
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return;

                                const amount = parseFloat(amountStr);
                                if (isNaN(amount)) return;

                                parsed.push({
                                    id: Date.now() + Math.random(), // 臨時 ID
                                    date: date,
                                    account: account,
                                    amount: amount,
                                    description: desc
                                });
                            });
                            resolve(parsed);
                        };
                        
                        // 根據選項決定編碼
                        const encoding = isCsvUtf8 ? 'UTF-8' : 'Big5';
                        reader.readAsText(file, encoding);
                    });
                };

                // 依序處理所有檔案
                Promise.all(Array.from(files).map(processFile)).then((results) => {
                    const allParsed = results.flat();
                    
                    if (allParsed.length === 0) {
                        alert("匯入失敗：未讀取到有效資料。請確認檔案格式是否正確，或嘗試切換編碼 (UTF-8 / Big5)。");
                        return;
                    }

                    if (confirm(`成功讀取 ${allParsed.length} 筆交易紀錄。\n是否確定要匯入並「附加」到現有紀錄中？`)) {
                        // 合併並排序
                        const merged = [...entries, ...allParsed].sort((a, b) => {
                            return new Date(b.date) - new Date(a.date);
                        });
                        setEntries(merged);
                        alert("匯入完成！");
                    }
                    event.target.value = ''; // 重置 input
                });
            };

            const triggerFileInput = () => fileInputRef.current.click();
            const triggerCsvInput = () => csvInputRef.current.click();

             // --- 報表計算 ---
            const currentBalances = useMemo(() => {
                const balances = { ...openingBalances };
                allAccounts.forEach(acc => { if (balances[acc] === undefined) balances[acc] = 0; });
                entries.forEach(entry => {
                    if (balances[entry.account] === undefined) balances[entry.account] = 0;
                    balances[entry.account] += entry.amount;
                });
                return balances;
            }, [entries, openingBalances, allAccounts]);

            const bsData = useMemo(() => {
                const assets = categories.ASSETS.map(acc => ({ name: acc, amount: currentBalances[acc] })).filter(i => i.amount !== 0);
                const liabilities = categories.LIABILITIES.map(acc => ({ name: acc, amount: currentBalances[acc] })).filter(i => i.amount !== 0);
                const totalAssets = assets.reduce((sum, item) => sum + item.amount, 0);
                const totalLiabilities = liabilities.reduce((sum, item) => sum + item.amount, 0); 
                const netIncome = -(entries.reduce((sum, e) => {
                    const type = getAccountType(e.account);
                    return (type === '收入' || type === '支出') ? sum + e.amount : sum;
                }, 0));
                return {
                    assets, totalAssets,
                    liabilities: liabilities.map(l => ({ ...l, amount: -l.amount })),
                    totalDisplayLiab: -totalLiabilities,
                    equity: netIncome
                };
            }, [currentBalances, entries, categories]);

            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));
            const isData = useMemo(() => {
                const monthlyEntries = entries.filter(e => e.date.startsWith(reportMonth));
                const incomes = {};
                const expenses = {};
                monthlyEntries.forEach(e => {
                    const type = getAccountType(e.account);
                    if (type === '收入') incomes[e.account] = (incomes[e.account] || 0) - e.amount;
                    else if (type === '支出') expenses[e.account] = (expenses[e.account] || 0) + e.amount;
                });
                const incomeList = Object.entries(incomes).map(([name, amount]) => ({ name, amount })).sort((a,b) => b.amount - a.amount);
                const expenseList = Object.entries(expenses).map(([name, amount]) => ({ name, amount })).sort((a,b) => b.amount - a.amount);
                const totalIncome = incomeList.reduce((sum, i) => sum + i.amount, 0);
                const totalExpense = expenseList.reduce((sum, i) => sum + i.amount, 0);
                return { incomeList, expenseList, totalIncome, totalExpense, netIncome: totalIncome - totalExpense };
            }, [entries, reportMonth, categories]);


            // --- UI Renders ---

            const renderJournal = () => {
                const filteredEntries = filterAccount 
                    ? entries.filter(e => e.account === filterAccount)
                    : entries;

                return (
                <div className="space-y-4 pb-24">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <div className="bg-red-100 p-1.5 rounded-lg text-red-600"><Icons.Plus /></div> 新增交易
                        </h3>
                        <form onSubmit={handleAddEntry} className="space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-medium text-gray-500 mb-1 block">日期</label>
                                    <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)} className="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm" required />
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-500 mb-1 block">金額</label>
                                    <input type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0" className="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-lg font-bold text-gray-800" required />
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs font-medium text-gray-500 mb-1 block">借方 (流入/費用)</label>
                                    <select value={drAccount} onChange={e => setDrAccount(e.target.value)} className="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm appearance-none" required>
                                        <option value="">選擇...</option>
                                        <optgroup label="資產 (Assets)">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="費用 (Expenses)">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="負債 (Liabilities)">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="收入 (Income)">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-medium text-gray-500 mb-1 block">貸方 (流出/收入)</label>
                                    <select value={crAccount} onChange={e => setCrAccount(e.target.value)} className="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm appearance-none" required>
                                        <option value="">選擇...</option>
                                        <optgroup label="資產 (Assets)">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="費用 (Expenses)">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="負債 (Liabilities)">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="收入 (Income)">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    </select>
                                </div>
                            </div>

                            <div className="flex gap-2 items-end">
                                <div className="flex-1">
                                    <label className="text-xs font-medium text-gray-500 mb-1 block">摘要</label>
                                    <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="例如: 午餐" className="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm" />
                                </div>
                                <button type="submit" className="bg-red-600 text-white p-2.5 rounded-lg shadow-lg shadow-red-200 active:scale-95 transition-transform flex items-center justify-center h-[42px] w-[42px]">
                                    <Icons.Save />
                                </button>
                            </div>
                        </form>
                    </div>

                    <div className="space-y-3">
                        <div className="flex justify-between items-center px-1">
                             <h3 className="font-bold text-gray-700 text-sm">最近交易 (可編輯)</h3>
                             <div className="flex items-center gap-1 bg-white border border-gray-200 rounded-lg px-2 py-1 shadow-sm">
                                <Icons.Filter />
                                <select 
                                    value={filterAccount} 
                                    onChange={(e) => setFilterAccount(e.target.value)}
                                    className="text-xs bg-transparent border-none outline-none text-gray-600 w-32"
                                >
                                    <option value="">全部顯示</option>
                                    <optgroup label="資產 (Assets)">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="負債 (Liabilities)">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="收入 (Income)">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="費用 (Expenses)">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                </select>
                             </div>
                        </div>

                        {filteredEntries.slice(0, 50).map(entry => (
                            <div key={entry.id} className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center">
                                {editingId === entry.id ? (
                                    <div className="flex flex-col w-full gap-2">
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="text" 
                                                value={editDescription} 
                                                onChange={e => setEditDescription(e.target.value)} 
                                                className="flex-1 border p-1 rounded text-sm"
                                                placeholder="摘要"
                                            />
                                        </div>
                                        <div className="flex items-center justify-between gap-2">
                                            <input 
                                                type="number" 
                                                value={editAmount} 
                                                onChange={e => setEditAmount(e.target.value)} 
                                                className="w-24 border p-1 rounded text-sm text-right"
                                                placeholder="金額"
                                            />
                                            <div className="flex gap-2">
                                                <button onClick={() => saveEditing(entry.id)} className="bg-green-100 text-green-600 p-1.5 rounded"><Icons.Check /></button>
                                                <button onClick={cancelEditing} className="bg-gray-100 text-gray-600 p-1.5 rounded"><Icons.X /></button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <React.Fragment>
                                        <div className="flex flex-col gap-1 flex-1">
                                            <div className="flex items-center gap-2">
                                                <span className="text-xs text-gray-400 bg-gray-100 px-1.5 py-0.5 rounded">{entry.date.slice(5)}</span>
                                                <span className={`text-xs px-1.5 py-0.5 rounded ${getAccountStyle(entry.account)}`}>{entry.account}</span>
                                            </div>
                                            <span className="text-sm text-gray-700 truncate max-w-[150px]">{entry.description || '-'}</span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className={`text-base font-mono font-bold ${entry.amount >= 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                {Math.abs(entry.amount).toLocaleString()}
                                            </span>
                                            <div className="flex gap-1">
                                                <button onClick={() => startEditing(entry)} className="text-gray-300 hover:text-blue-500 p-1"><Icons.Edit /></button>
                                                <button onClick={() => handleDeleteEntry(entry.id)} className="text-gray-300 hover:text-red-500 p-1"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    </React.Fragment>
                                )}
                            </div>
                        ))}
                        {filteredEntries.length === 0 && (
                            <div className="text-center py-8 text-gray-400 text-sm bg-white rounded-xl border border-gray-100 border-dashed">
                                {filterAccount ? `查無「${filterAccount}」的交易紀錄` : '尚無紀錄'}
                            </div>
                        )}
                    </div>
                </div>
                );
            };

             const renderReports = () => (
                <div className="space-y-6 pb-24">
                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.BookOpen /> 資產負債表</h3>
                        </div>
                        <div className="space-y-3 text-sm">
                            <div className="flex justify-between p-2 bg-red-50 rounded"><span>總資產</span><span className="font-bold text-red-700">{bsData.totalAssets.toLocaleString()}</span></div>
                            <div className="flex justify-between p-2 bg-green-50 rounded"><span>總負債</span><span className="font-bold text-green-700">{bsData.totalDisplayLiab.toLocaleString()}</span></div>
                            <div className="flex justify-between p-2 bg-gray-50 rounded"><span>本期損益</span><span className={`font-bold ${bsData.equity >= 0 ? 'text-red-700' : 'text-green-700'}`}>{bsData.equity.toLocaleString()}</span></div>
                            
                            {/* 資產明細 */}
                            <div className="mt-4 pt-3 border-t">
                                <h4 className="text-xs text-gray-500 mb-2">資產明細 (Assets)</h4>
                                {bsData.assets.map(a => <div key={a.name} className="flex justify-between py-1 text-gray-600"><span>{a.name}</span><span className="text-red-600">{a.amount.toLocaleString()}</span></div>)}
                            </div>

                            {/* 負債明細 */}
                            <div className="mt-4 pt-3 border-t">
                                <h4 className="text-xs text-gray-500 mb-2">負債明細 (Liabilities)</h4>
                                {bsData.liabilities.length > 0 ? (
                                    bsData.liabilities.map(l => (
                                        <div key={l.name} className="flex justify-between py-1 text-gray-600">
                                            <span>{l.name}</span>
                                            <span className="text-green-600">{l.amount.toLocaleString()}</span>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-xs text-gray-400 italic">目前無負債</div>
                                )}
                            </div>
                        </div>
                    </div>

                     <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-gray-800 flex items-center gap-2"><Icons.PieChart /> 損益表</h3>
                            <input type="month" value={reportMonth} onChange={(e) => setReportMonth(e.target.value)} className="text-xs border rounded p-1" />
                        </div>
                        <div className="text-center py-4 bg-gray-50 rounded-lg mb-4">
                            <span className="text-xs text-gray-500 block mb-1">本月淨利</span>
                            <span className={`text-2xl font-bold ${isData.netIncome >= 0 ? 'text-red-600' : 'text-green-600'}`}>{isData.netIncome.toLocaleString()}</span>
                        </div>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <h4 className="font-bold text-red-700 mb-2 border-b pb-1">收入: {isData.totalIncome.toLocaleString()}</h4>
                                {isData.incomeList.map(i => <div key={i.name} className="flex justify-between text-xs py-1"><span>{i.name}</span><span className="text-red-600">{i.amount.toLocaleString()}</span></div>)}
                            </div>
                            <div>
                                <h4 className="font-bold text-green-700 mb-2 border-b pb-1">支出: {isData.totalExpense.toLocaleString()}</h4>
                                {isData.expenseList.map(i => <div key={i.name} className="flex justify-between text-xs py-1"><span>{i.name}</span><span className="text-green-600">{i.amount.toLocaleString()}</span></div>)}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderAccounts = () => {
                // 定義區塊顏色 (紅=資產/收入, 綠=負債/支出)
                const sectionStyle = (key) => {
                    if (key === 'ASSETS' || key === 'INCOME') return { header: 'text-red-700 bg-red-50', icon: 'bg-red-500 text-white' };
                    return { header: 'text-green-700 bg-green-50', icon: 'bg-green-500 text-white' };
                };

                return (
                <div className="space-y-4 pb-24">
                     {['ASSETS', 'LIABILITIES', 'INCOME', 'EXPENSES'].map(key => (
                        <div key={key} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                            <div className={`p-3 border-b flex justify-between items-center ${sectionStyle(key).header}`}>
                                <span className="font-bold text-sm">{key === 'ASSETS' ? '資產' : key === 'LIABILITIES' ? '負債' : key === 'INCOME' ? '收入' : '支出'}</span>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="新增..." value={newAccountInputs[key]} onChange={e => setNewAccountInputs({...newAccountInputs, [key]: e.target.value})} className="text-xs p-1 border rounded w-24 bg-white/50" />
                                    <button onClick={() => handleAddAccount(key)} className={`${sectionStyle(key).icon} px-2 rounded text-xs`}><Icons.Plus /></button>
                                </div>
                            </div>
                            <div className="p-2 max-h-40 overflow-y-auto">
                                {categories[key].map(acc => (
                                    <div key={acc} className="flex justify-between items-center py-2 px-1 border-b last:border-0 border-gray-50">
                                        <span className="text-sm text-gray-600">{acc}</span>
                                        <button onClick={() => handleDeleteAccount(key, acc)} className="text-gray-300 hover:text-red-500"><Icons.X /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                     ))}
                </div>
            )};
            
            const renderSettings = () => (
                <div className="space-y-6 pb-24">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-800 mb-4">期初餘額設定 (2023/01/01)</h3>
                        
                        <div className="space-y-6">
                            {/* 資產區塊 (紅) */}
                            <div>
                                <h4 className="text-sm font-bold text-red-700 bg-red-50 p-2 rounded mb-2">資產 (Assets)</h4>
                                <div className="space-y-3">
                                    {categories.ASSETS.map(acc => (
                                        <div key={acc} className="flex justify-between items-center border-b border-gray-50 last:border-0 pb-1">
                                            <label className="text-xs text-gray-600 flex-1">{acc}</label>
                                            <input 
                                                type="number" 
                                                value={openingBalances[acc] !== undefined ? openingBalances[acc] : 0} 
                                                onChange={e => setOpeningBalances({...openingBalances, [acc]: parseFloat(e.target.value) || 0})} 
                                                className="border rounded p-1.5 text-sm w-32 text-right font-mono"
                                                placeholder="0"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* 負債區塊 (綠) */}
                            <div>
                                <h4 className="text-sm font-bold text-green-700 bg-green-50 p-2 rounded mb-2">負債 (Liabilities)</h4>
                                <p className="text-[10px] text-gray-400 mb-2 px-1">* 請輸入負數表示欠款</p>
                                <div className="space-y-3">
                                    {categories.LIABILITIES.map(acc => (
                                        <div key={acc} className="flex justify-between items-center border-b border-gray-50 last:border-0 pb-1">
                                            <label className="text-xs text-gray-600 flex-1">{acc}</label>
                                            <input 
                                                type="number" 
                                                value={openingBalances[acc] !== undefined ? openingBalances[acc] : 0} 
                                                onChange={e => setOpeningBalances({...openingBalances, [acc]: parseFloat(e.target.value) || 0})} 
                                                className="border rounded p-1.5 text-sm w-32 text-right font-mono text-green-600"
                                                placeholder="0"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="p-4 bg-blue-50 text-blue-700 text-xs rounded mt-6">
                            提示：此處顯示的所有科目皆同步自「科目管理」頁面。
                        </div>
                    </div>

                    {/* 資料管理區塊 */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <Icons.Save /> 資料備份與還原
                        </h3>
                        
                        <div className="space-y-4">
                            <div className="space-y-2">
                                <h4 className="text-xs font-bold text-gray-500 uppercase">匯出資料 (Backup)</h4>
                                <button onClick={exportToJSON} className="w-full flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition group">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-blue-800">下載完整備份檔 (.json)</span>
                                        <span className="text-xs text-blue-600/70">換手機或換網址時使用</span>
                                    </div>
                                    <span className="text-blue-600"><Icons.Download /></span>
                                </button>
                                
                                <button onClick={exportToCSV} className="w-full flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-gray-700">下載交易明細 (.csv)</span>
                                        <span className="text-xs text-gray-500">僅供 Excel 分析使用</span>
                                    </div>
                                    <span className="text-gray-400"><Icons.FileText /></span>
                                </button>
                            </div>

                            <div className="border-t pt-4 space-y-2">
                                <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-1">
                                    匯入資料 (Restore) <Icons.AlertTriangle className="w-3 h-3 text-yellow-500" />
                                </h4>
                                <p className="text-[10px] text-gray-400 mb-2">注意：匯入將會覆蓋目前的設定與交易紀錄。</p>
                                
                                <input 
                                    type="file" 
                                    accept=".json" 
                                    ref={fileInputRef} 
                                    onChange={handleImportJSON} 
                                    style={{ display: 'none' }} 
                                />
                                <button onClick={triggerFileInput} className="w-full flex items-center justify-between p-3 bg-yellow-50 border border-yellow-200 rounded-lg hover:bg-yellow-100 transition dashed-border">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-yellow-800">選擇備份檔匯入</span>
                                        <span className="text-xs text-yellow-700/70">點此還原之前的 .json 檔案</span>
                                    </div>
                                    <span className="text-yellow-600"><Icons.Upload /></span>
                                </button>
                            </div>

                            <div className="border-t pt-4 space-y-2">
                                <div className="flex justify-between items-center">
                                    <h4 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-1">
                                        匯入舊版 Excel CSV
                                    </h4>
                                    <div className="flex items-center gap-2 text-xs text-gray-500">
                                        <label className="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" checked={isCsvUtf8} onChange={() => setIsCsvUtf8(true)} /> UTF-8
                                        </label>
                                        <label className="flex items-center gap-1 cursor-pointer">
                                            <input type="radio" checked={!isCsvUtf8} onChange={() => setIsCsvUtf8(false)} /> Big5
                                        </label>
                                    </div>
                                </div>
                                <p className="text-[10px] text-gray-400 mb-2">支援匯入您之前的 JE_*.csv 檔案。若文字亂碼請切換 Big5。</p>
                                
                                <input 
                                    type="file" 
                                    accept=".csv" 
                                    multiple
                                    ref={csvInputRef} 
                                    onChange={handleImportCSV} 
                                    style={{ display: 'none' }} 
                                />
                                <button onClick={triggerCsvInput} className="w-full flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition dashed-border">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-green-800">匯入 CSV 交易紀錄</span>
                                        <span className="text-xs text-green-700/70">可多選檔案</span>
                                    </div>
                                    <span className="text-green-600"><Icons.FilePlus /></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 safe-area-bottom">
                    <div className="sticky top-0 z-10 bg-white/90 backdrop-blur border-b px-4 py-3 shadow-sm">
                        <h1 className="text-lg font-bold text-center text-gray-800">記帳簿 <span className="text-xs font-normal text-red-600 bg-red-50 px-2 py-0.5 rounded-full">App</span></h1>
                    </div>

                    <div className="p-4">
                        {activeTab === 'journal' && renderJournal()}
                        {activeTab === 'reports' && renderReports()}
                        {activeTab === 'accounts' && renderAccounts()}
                        {activeTab === 'settings' && renderSettings()}
                    </div>

                    {/* Mobile Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-6 py-2 pb-6 safe-area-bottom flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
                        <button onClick={() => setActiveTab('journal')} className={`flex flex-col items-center gap-1 ${activeTab === 'journal' ? 'text-red-600' : 'text-gray-400'}`}>
                            <div className="p-1"><Icons.Plus /></div>
                            <span className="text-[10px] font-medium">記帳</span>
                        </button>
                        <button onClick={() => setActiveTab('reports')} className={`flex flex-col items-center gap-1 ${activeTab === 'reports' ? 'text-red-600' : 'text-gray-400'}`}>
                             <div className="p-1"><Icons.BookOpen /></div>
                            <span className="text-[10px] font-medium">報表</span>
                        </button>
                        <button onClick={() => setActiveTab('accounts')} className={`flex flex-col items-center gap-1 ${activeTab === 'accounts' ? 'text-red-600' : 'text-gray-400'}`}>
                             <div className="p-1"><Icons.List /></div>
                            <span className="text-[10px] font-medium">科目</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 ${activeTab === 'settings' ? 'text-red-600' : 'text-gray-400'}`}>
                             <div className="p-1"><Icons.Settings /></div>
                            <span className="text-[10px] font-medium">設定</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
