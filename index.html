<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- iOS Web App 專用設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="記帳簿">
    
    <!-- 設定 App 圖示 (iOS & Desktop) -->
    <!-- 這裡使用 ui-avatars 生成一個藍底白字的 "帳" 字圖示，您可以將 href 換成自己的圖片網址 -->
    <link rel="apple-touch-icon" href="https://ui-avatars.com/api/?name=帳&background=2563eb&color=fff&rounded=true&bold=true&size=512">
    <link rel="icon" type="image/png" href="https://ui-avatars.com/api/?name=帳&background=2563eb&color=fff&rounded=true&bold=true&size=512">

    <title>個人會計記帳系統 </title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 使用最新版 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            color: #475569; 
        }
        .overflow-y-auto { -webkit-overflow-scrolling: touch; }
        
        /* 導航欄樣式 - 更加圓潤 */
        .tab-active { 
            color: #0f172a; /* Slate-900 */
            font-weight: 700;
            background-color: #e2e8f0;
            border-radius: 12px;
        }
        .tab-inactive { color: #94a3b8; font-weight: 500; } 
        
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        /* --- 和諧配色定義 (Blue & Amber) --- */
        
        /* 資產/收入: 藍色系 (穩定、流入) */
        .text-asset { color: #2563eb; } /* Blue-600 */
        .bg-asset { background-color: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; } /* Blue-50 */
        
        /* 負債/支出: 橘色系 (溫暖、流出) */
        .text-liab { color: #d97706; } /* Amber-600 */
        .bg-liab { background-color: #fffbeb; color: #92400e; border: 1px solid #fef3c7; } /* Amber-50 */

        /* 輸入框聚焦效果 */
        input:focus, select:focus {
            outline: none;
            border-color: #cbd5e1;
            box-shadow: 0 0 0 3px rgba(226, 232, 240, 0.6);
        }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        
        const Icons = {
            BookOpen: () => <i data-lucide="book-open" className="w-5 h-5"></i>,
            PieChart: () => <i data-lucide="pie-chart" className="w-5 h-5"></i>,
            Settings: () => <i data-lucide="settings" className="w-5 h-5"></i>,
            List: () => <i data-lucide="list" className="w-5 h-5"></i>,
            Plus: () => <i data-lucide="plus" className="w-4 h-4"></i>,
            Trash: () => <i data-lucide="trash-2" className="w-4 h-4"></i>,
            ArrowRight: () => <i data-lucide="arrow-right" className="w-4 h-4 inline mx-2"></i>,
            Save: () => <i data-lucide="save" className="w-4 h-4"></i>,
            X: () => <i data-lucide="x" className="w-4 h-4"></i>,
            Filter: () => <i data-lucide="filter" className="w-3 h-3"></i>,
            Download: () => <i data-lucide="download" className="w-4 h-4"></i>,
            Upload: () => <i data-lucide="upload" className="w-4 h-4"></i>,
            FileText: () => <i data-lucide="file-text" className="w-4 h-4"></i>,
            AlertTriangle: () => <i data-lucide="alert-triangle" className="w-4 h-4"></i>,
            Edit: () => <i data-lucide="edit-2" className="w-4 h-4"></i>,
            Check: () => <i data-lucide="check" className="w-4 h-4"></i>,
            FilePlus: () => <i data-lucide="file-plus" className="w-4 h-4"></i>,
            Wallet: () => <i data-lucide="wallet" className="w-5 h-5"></i>
        };

        const DEFAULT_CATEGORIES = {
            ASSETS: [
                "現金-錢包-台幣", "現金-Line-台幣", "現金-悠遊卡-台新", "現金-悠遊卡-花旗",
                "銀行存款-渣打-台幣", "銀行存款-台新-台幣", "銀行存款-國泰-台幣", "銀行存款-國泰-外幣", "銀行存款-元大-台幣",
                "應收帳款-公司-美甲社", "應收帳款-私人-媽媽", "應收帳款-私人-瑋",
                "股票投資-台股-成本", "股票投資-台股-評價",
                "儲蓄險-祿美利利-外幣", "儲蓄險-雋美年年-外幣", "儲蓄險-樂事年年-台幣", "儲蓄險-祿美佳-外幣",
                "預付款項-健身教練", "預付款項-羽球場", "預付款項-麥當勞"
            ],
            LIABILITIES: [
                "信用卡-台新-Richart", "信用卡-國泰-蝦皮/koko", "信用卡-花旗-現金回饋", "信用卡-富邦-momo", "信用卡-元大-鑽金",
                "應付帳款-Brian", "應付帳款-其他", "未實現-台股-評價"
            ],
            INCOME: [
                "薪資", "利息收入", "股利收入", "獎金", "投資收益", "其他收入"
            ],
            EXPENSES: [
                "租金支出-房租管理費", "租金支出-水費", "租金支出-電費",
                "伙食費", "保險費", "外在支出-彩妝保養", "外在支出-服裝飾品",
                "交際費", "交通費", "電話費", "生活用品", "運動健康",
                "旅遊-機加酒", "旅遊-伙食", "旅遊-交通", "旅遊-購物&其他",
                "醫療費", "雜費"
            ]
        };

        const DEFAULT_OPENING_BALANCES = {
            "現金-錢包-台幣": 1260,
            "現金-Line-台幣": 6129,
            "現金-悠遊卡-台新": 335,
            "現金-悠遊卡-花旗": 493,
            "銀行存款-渣打-台幣": 112247,
            "銀行存款-台新-台幣": 0,
            "銀行存款-國泰-台幣": 0,
            "銀行存款-國泰-外幣": 0,
            "銀行存款-元大-台幣": 0,
            "應收帳款-公司-美甲社": 0,
            "應收帳款-私人-媽媽": 0,
            "應收帳款-私人-瑋": 0,
            "股票投資-台股-成本": 0,
            "股票投資-台股-評價": 0,
            "儲蓄險-祿美利利-外幣": 0,
            "儲蓄險-雋美年年-外幣": 0,
            "儲蓄險-樂事年年-台幣": 0,
            "儲蓄險-祿美佳-外幣": 0,
            "預付款項-健身教練": 0,
            "預付款項-羽球場": 0,
            "預付款項-麥當勞": 0,
            "信用卡-台新-Richart": -7506,
            "信用卡-國泰-蝦皮/koko": -69,
            "信用卡-花旗-現金回饋": -29610,
            "信用卡-富邦-momo": -21168,
            "信用卡-元大-鑽金": 0,
            "應付帳款-Brian": 0,
            "應付帳款-其他": 0,
            "未實現-台股-評價": 0
        };

        const useStickyState = (defaultValue, key) => {
            const [value, setValue] = useState(() => {
                const stickyValue = window.localStorage.getItem(key);
                return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
            });
            useEffect(() => {
                window.localStorage.setItem(key, JSON.stringify(value));
            }, [key, value]);
            return [value, setValue];
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState("journal"); 
            const [categories, setCategories] = useStickyState(DEFAULT_CATEGORIES, "my_app_categories_v2");
            const [entries, setEntries] = useStickyState([], "my_app_entries_v2");
            const [openingBalances, setOpeningBalances] = useStickyState(DEFAULT_OPENING_BALANCES, "my_app_opening_balances_v2");
            
            const [newDate, setNewDate] = useState(new Date().toISOString().split('T')[0]);
            const [drAccount, setDrAccount] = useState("");
            const [crAccount, setCrAccount] = useState(""); 
            const [amount, setAmount] = useState("");
            const [description, setDescription] = useState("");
            const [isCsvUtf8, setIsCsvUtf8] = useState(true);
            
            const [editingId, setEditingId] = useState(null);
            const [editDescription, setEditDescription] = useState("");
            const [editAmount, setEditAmount] = useState("");
            
            const [filterAccount, setFilterAccount] = useState("");

            const [newAccountInputs, setNewAccountInputs] = useState({
                ASSETS: "", LIABILITIES: "", INCOME: "", EXPENSES: ""
            });

            const fileInputRef = useRef(null);
            const csvInputRef = useRef(null);

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [activeTab, categories, entries, filterAccount, editingId]);

            const allAccounts = useMemo(() => {
                return [
                    ...(categories.ASSETS || []),
                    ...(categories.LIABILITIES || []),
                    ...(categories.INCOME || []),
                    ...(categories.EXPENSES || [])
                ];
            }, [categories]);

            const getAccountType = (accountName) => {
                if (categories.ASSETS.includes(accountName)) return '資產';
                if (categories.LIABILITIES.includes(accountName)) return '負債';
                if (categories.INCOME.includes(accountName)) return '收入';
                if (categories.EXPENSES.includes(accountName)) return '支出';
                return '其他';
            };

            // 優化後的樣式函數 - 藍橘配色
            const getAccountStyle = (accountName) => {
                const type = getAccountType(accountName);
                switch (type) {
                    case '資產': case '收入': return 'bg-asset'; 
                    case '負債': case '支出': return 'bg-liab';
                    default: return 'text-slate-600 bg-slate-100';
                }
            };
            
            const handleAddEntry = (e) => {
                e.preventDefault();
                if (!drAccount || !crAccount || !amount) {
                    alert("請完整填寫交易資訊");
                    return;
                }
                const numAmount = parseFloat(amount);
                const id = Date.now();
                const drEntry = { id: id, date: newDate, account: drAccount, amount: numAmount, description: description };
                const crEntry = { id: id + 1, date: newDate, account: crAccount, amount: -numAmount, description: description };

                setEntries([drEntry, crEntry, ...entries]);
                setAmount("");
                setDescription("");
            };

            const handleDeleteEntry = (id) => {
                if(confirm("確定要刪除這筆分錄嗎？")) {
                    setEntries(entries.filter(e => e.id !== id));
                }
            };

            const startEditing = (entry) => {
                setEditingId(entry.id);
                setEditDescription(entry.description || "");
                setEditAmount(Math.abs(entry.amount));
            };

            const cancelEditing = () => {
                setEditingId(null);
                setEditDescription("");
                setEditAmount("");
            };

            const saveEditing = (id) => {
                const targetEntry = entries.find(e => e.id === id);
                if (!targetEntry) return;

                const newAmt = parseFloat(editAmount);
                const finalAmt = targetEntry.amount >= 0 ? newAmt : -newAmt;

                let partnerId = null;
                const partnerCandidates = entries.filter(e => 
                    Math.abs(e.id - id) <= 5 && 
                    e.date === targetEntry.date && 
                    e.amount === -targetEntry.amount
                );
                
                if (partnerCandidates.length === 1) {
                    partnerId = partnerCandidates[0].id;
                }

                setEntries(prevEntries => prevEntries.map(e => {
                    if (e.id === id) {
                        return { ...e, description: editDescription, amount: finalAmt };
                    }
                    if (e.id === partnerId && finalAmt !== targetEntry.amount) {
                        return { ...e, description: editDescription, amount: -finalAmt };
                    }
                    return e;
                }));

                setEditingId(null);
            };

            const handleAddAccount = (categoryKey) => {
                const name = newAccountInputs[categoryKey].trim();
                if (!name) return;
                if (allAccounts.includes(name)) {
                    alert("此科目已存在");
                    return;
                }
                setCategories(prev => ({
                    ...prev,
                    [categoryKey]: [...prev[categoryKey], name]
                }));
                setNewAccountInputs(prev => ({ ...prev, [categoryKey]: "" }));
            };

            const handleDeleteAccount = (categoryKey, name) => {
                 if (entries.some(e => e.account === name) || (openingBalances[name] && openingBalances[name] !== 0)) {
                    if (!confirm(`科目「${name}」已被使用，刪除可能導致報表異常。確定要刪除嗎？`)) return;
                } else {
                    if (!confirm(`確定要刪除「${name}」嗎？`)) return;
                }
                setCategories(prev => ({
                    ...prev,
                    [categoryKey]: prev[categoryKey].filter(item => item !== name)
                }));
            };

            const exportToJSON = () => {
                const data = { categories, entries, openingBalances, exportDate: new Date().toISOString(), appVersion: "2023_V2" };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `記帳簿備份_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const exportToCSV = () => {
                const bom = "\uFEFF";
                const headers = "ID,日期,會計科目,金額,摘要\n";
                const rows = entries.map(e => `${e.id},${e.date},${e.account},${e.amount},"${e.description || ''}"`).join("\n");
                const blob = new Blob([bom + headers + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `記帳明細_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportJSON = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (!importedData.categories || !importedData.entries || !importedData.openingBalances) throw new Error("格式錯誤");
                        if(confirm(`確定要還原備份嗎？目前的資料將會被覆蓋。`)) {
                            setCategories(importedData.categories);
                            setEntries(importedData.entries);
                            setOpeningBalances(importedData.openingBalances);
                            alert("還原成功！");
                        }
                    } catch (error) {
                        alert("匯入失敗：" + error.message);
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            const handleImportCSV = (event) => {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                const processFile = (file) => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const lines = e.target.result.split(/\r\n|\n/);
                            const parsed = [];
                            let isHeader = true;
                            lines.forEach((line) => {
                                if (!line.trim()) return;
                                const row = line.split(',');
                                if (isHeader) {
                                    if (row[0].includes('日期') || row[1].includes('會計科目')) { isHeader = false; return; }
                                    isHeader = false;
                                }
                                if (row.length < 3) return;
                                const date = row[0].trim();
                                if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) return;
                                const amount = parseFloat(row[2].trim());
                                if (isNaN(amount)) return;
                                parsed.push({ id: Date.now() + Math.random(), date, account: row[1].trim(), amount, description: row[3] ? row[3].trim() : "" });
                            });
                            resolve(parsed);
                        };
                        reader.readAsText(file, isCsvUtf8 ? 'UTF-8' : 'Big5');
                    });
                };
                Promise.all(Array.from(files).map(processFile)).then((results) => {
                    const allParsed = results.flat();
                    if (allParsed.length === 0) { alert("匯入失敗：無有效資料"); return; }
                    if (confirm(`讀取到 ${allParsed.length} 筆資料，確定匯入？`)) {
                        setEntries([...entries, ...allParsed].sort((a, b) => new Date(b.date) - new Date(a.date)));
                        alert("匯入完成");
                    }
                    event.target.value = '';
                });
            };

            const triggerFileInput = () => fileInputRef.current.click();
            const triggerCsvInput = () => csvInputRef.current.click();

            const currentBalances = useMemo(() => {
                const balances = { ...openingBalances };
                allAccounts.forEach(acc => { if (balances[acc] === undefined) balances[acc] = 0; });
                entries.forEach(entry => {
                    if (balances[entry.account] === undefined) balances[entry.account] = 0;
                    balances[entry.account] += entry.amount;
                });
                return balances;
            }, [entries, openingBalances, allAccounts]);

            const bsData = useMemo(() => {
                const assets = categories.ASSETS.map(acc => ({ name: acc, amount: currentBalances[acc] })).filter(i => i.amount !== 0);
                const liabilities = categories.LIABILITIES.map(acc => ({ name: acc, amount: currentBalances[acc] })).filter(i => i.amount !== 0);
                const totalAssets = assets.reduce((sum, item) => sum + item.amount, 0);
                const totalLiabilities = liabilities.reduce((sum, item) => sum + item.amount, 0); 
                const netIncome = -(entries.reduce((sum, e) => {
                    const type = getAccountType(e.account);
                    return (type === '收入' || type === '支出') ? sum + e.amount : sum;
                }, 0));
                return {
                    assets, totalAssets,
                    liabilities: liabilities.map(l => ({ ...l, amount: -l.amount })),
                    totalDisplayLiab: -totalLiabilities,
                    equity: netIncome
                };
            }, [currentBalances, entries, categories]);

            const [reportMonth, setReportMonth] = useState(new Date().toISOString().slice(0, 7));
            const isData = useMemo(() => {
                const monthlyEntries = entries.filter(e => e.date.startsWith(reportMonth));
                const incomes = {};
                const expenses = {};
                monthlyEntries.forEach(e => {
                    const type = getAccountType(e.account);
                    if (type === '收入') incomes[e.account] = (incomes[e.account] || 0) - e.amount;
                    else if (type === '支出') expenses[e.account] = (expenses[e.account] || 0) + e.amount;
                });
                const incomeList = Object.entries(incomes).map(([name, amount]) => ({ name, amount })).sort((a,b) => b.amount - a.amount);
                const expenseList = Object.entries(expenses).map(([name, amount]) => ({ name, amount })).sort((a,b) => b.amount - a.amount);
                const totalIncome = incomeList.reduce((sum, i) => sum + i.amount, 0);
                const totalExpense = expenseList.reduce((sum, i) => sum + i.amount, 0);
                return { incomeList, expenseList, totalIncome, totalExpense, netIncome: totalIncome - totalExpense };
            }, [entries, reportMonth, categories]);


            // --- UI Renders ---

            const renderJournal = () => {
                const filteredEntries = filterAccount ? entries.filter(e => e.account === filterAccount) : entries;

                return (
                <div className="space-y-6 pb-28">
                    {/* Add Entry Card */}
                    <div className="bg-white p-6 rounded-2xl border border-slate-100 card-shadow">
                        <h3 className="text-lg font-bold text-slate-700 mb-5 flex items-center gap-2">
                            <div className="bg-slate-100 p-2 rounded-xl text-slate-600"><Icons.Plus /></div> 
                            <span>新增交易</span>
                        </h3>
                        <form onSubmit={handleAddEntry} className="space-y-5">
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs font-medium text-slate-400 ml-1">日期</label>
                                    <input type="date" value={newDate} onChange={e => setNewDate(e.target.value)} className="w-full p-3 bg-slate-50 border border-transparent rounded-xl text-sm transition-all focus:bg-white" required />
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-medium text-slate-400 ml-1">金額</label>
                                    <input type="number" inputMode="decimal" value={amount} onChange={e => setAmount(e.target.value)} placeholder="0" className="w-full p-3 bg-slate-50 border border-transparent rounded-xl text-lg font-bold text-slate-700 transition-all text-right focus:bg-white" required />
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="space-y-1">
                                    <label className="text-xs font-medium text-slate-400 ml-1 flex items-center gap-1">
                                        <span className="w-2 h-2 rounded-full bg-blue-500"></span> 借方 (流入/費用)
                                    </label>
                                    <select value={drAccount} onChange={e => setDrAccount(e.target.value)} className="w-full p-3 bg-slate-50 border border-transparent rounded-xl text-sm appearance-none transition-all focus:bg-white" required>
                                        <option value="">選擇科目...</option>
                                        <optgroup label="費用 (Expenses)">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="資產 (Assets)">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="負債 (Liabilities)">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="收入 (Income)">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    </select>
                                </div>
                                <div className="space-y-1">
                                    <label className="text-xs font-medium text-slate-400 ml-1 flex items-center gap-1">
                                        <span className="w-2 h-2 rounded-full bg-amber-500"></span> 貸方 (流出/收入)
                                    </label>
                                    <select value={crAccount} onChange={e => setCrAccount(e.target.value)} className="w-full p-3 bg-slate-50 border border-transparent rounded-xl text-sm appearance-none transition-all focus:bg-white" required>
                                        <option value="">選擇科目...</option>
                                        <optgroup label="資產 (Assets)">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="費用 (Expenses)">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="負債 (Liabilities)">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                        <optgroup label="收入 (Income)">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    </select>
                                </div>
                            </div>

                            <div className="flex gap-3 items-end">
                                <div className="flex-1 space-y-1">
                                    <label className="text-xs font-medium text-slate-400 ml-1">摘要</label>
                                    <input type="text" value={description} onChange={e => setDescription(e.target.value)} placeholder="例如: 午餐" className="w-full p-3 bg-slate-50 border border-transparent rounded-xl text-sm transition-all focus:bg-white" />
                                </div>
                                <button type="submit" className="bg-slate-700 text-white p-3 rounded-xl shadow-lg shadow-slate-300 active:scale-95 transition-all flex items-center justify-center h-[46px] w-[56px] hover:bg-slate-800">
                                    <Icons.Save />
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Entry List */}
                    <div className="space-y-3">
                        <div className="flex justify-between items-center px-2">
                             <h3 className="font-bold text-slate-600 text-sm">最近交易</h3>
                             <div className="flex items-center gap-2 bg-white border border-slate-200 rounded-full px-3 py-1.5 shadow-sm">
                                <Icons.Filter className="text-slate-400" />
                                <select 
                                    value={filterAccount} 
                                    onChange={(e) => setFilterAccount(e.target.value)}
                                    className="text-xs bg-transparent border-none outline-none text-slate-600 w-28 cursor-pointer"
                                >
                                    <option value="">全部顯示</option>
                                    <optgroup label="資產">{categories.ASSETS.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="負債">{categories.LIABILITIES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="收入">{categories.INCOME.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                    <optgroup label="費用">{categories.EXPENSES.map(a => <option key={a} value={a}>{a}</option>)}</optgroup>
                                </select>
                             </div>
                        </div>

                        {filteredEntries.slice(0, 50).map(entry => (
                            <div key={entry.id} className="bg-white p-4 rounded-2xl border border-slate-50 flex justify-between items-center transition-all hover:shadow-md">
                                {editingId === entry.id ? (
                                    <div className="flex flex-col w-full gap-3">
                                        <input type="text" value={editDescription} onChange={e => setEditDescription(e.target.value)} className="w-full border p-2 rounded-lg text-sm bg-slate-50" placeholder="摘要" />
                                        <div className="flex items-center justify-between gap-3">
                                            <input type="number" value={editAmount} onChange={e => setEditAmount(e.target.value)} className="w-full border p-2 rounded-lg text-sm text-right font-mono" placeholder="金額" />
                                            <div className="flex gap-2">
                                                <button onClick={() => saveEditing(entry.id)} className="bg-slate-100 text-slate-600 p-2 rounded-lg"><Icons.Check /></button>
                                                <button onClick={cancelEditing} className="bg-slate-100 text-slate-500 p-2 rounded-lg"><Icons.X /></button>
                                            </div>
                                        </div>
                                    </div>
                                ) : (
                                    <React.Fragment>
                                        <div className="flex flex-col gap-1.5 flex-1 min-w-0">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className="text-[10px] text-slate-400 font-medium bg-slate-50 px-2 py-0.5 rounded-full">{entry.date.slice(5)}</span>
                                                <span className={`text-[11px] px-2 py-0.5 rounded-md font-medium truncate max-w-[180px] ${getAccountStyle(entry.account)}`}>{entry.account}</span>
                                            </div>
                                            <span className="text-sm text-slate-600 truncate pl-1">{entry.description || '-'}</span>
                                        </div>
                                        <div className="flex flex-col items-end gap-1 pl-3">
                                            <span className={`text-base font-mono font-bold ${entry.amount >= 0 ? 'text-asset' : 'text-liab'}`}>
                                                {Math.abs(entry.amount).toLocaleString()}
                                            </span>
                                            <div className="flex gap-3 opacity-30 hover:opacity-100 transition-opacity">
                                                <button onClick={() => startEditing(entry)} className="text-slate-400 hover:text-slate-600"><Icons.Edit /></button>
                                                <button onClick={() => handleDeleteEntry(entry.id)} className="text-slate-400 hover:text-rose-400"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    </React.Fragment>
                                )}
                            </div>
                        ))}
                        {filteredEntries.length === 0 && (
                            <div className="text-center py-12 text-slate-400 text-sm bg-white rounded-2xl border border-slate-100 border-dashed">
                                {filterAccount ? `查無「${filterAccount}」的交易紀錄` : '目前沒有交易紀錄'}
                            </div>
                        )}
                    </div>
                </div>
                );
            };

             const renderReports = () => (
                <div className="space-y-6 pb-28">
                     <div className="bg-white p-5 rounded-2xl border border-slate-100 card-shadow">
                        <div className="flex justify-between items-center mb-5">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icons.BookOpen /> 資產負債表</h3>
                        </div>
                        <div className="space-y-3 text-sm">
                            <div className="flex justify-between p-3 bg-blue-50 rounded-xl border border-blue-100">
                                <span className="text-blue-700 font-medium">總資產 (Assets)</span>
                                <span className="font-bold text-blue-600 font-mono text-base">{bsData.totalAssets.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between p-3 bg-amber-50 rounded-xl border border-amber-100">
                                <span className="text-amber-700 font-medium">總負債 (Liabilities)</span>
                                <span className="font-bold text-amber-600 font-mono text-base">{bsData.totalDisplayLiab.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between p-3 bg-slate-50 rounded-xl border border-slate-100">
                                <span className="text-slate-600 font-medium">本期損益 (Equity)</span>
                                <span className={`font-bold font-mono text-base ${bsData.equity >= 0 ? 'text-asset' : 'text-liab'}`}>{bsData.equity.toLocaleString()}</span>
                            </div>
                            
                            {/* 資產明細 */}
                            <div className="mt-6 pt-2">
                                <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 ml-1 tracking-wider">資產明細</h4>
                                {bsData.assets.map(a => (
                                    <div key={a.name} className="flex justify-between py-2 border-b border-slate-50 last:border-0 text-slate-600 hover:bg-slate-50 px-2 rounded-lg transition-colors">
                                        <span>{a.name}</span><span className="text-asset font-mono">{a.amount.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>

                            {/* 負債明細 */}
                            <div className="mt-6 pt-2">
                                <h4 className="text-xs font-bold text-slate-400 uppercase mb-3 ml-1 tracking-wider">負債明細</h4>
                                {bsData.liabilities.length > 0 ? (
                                    bsData.liabilities.map(l => (
                                        <div key={l.name} className="flex justify-between py-2 border-b border-slate-50 last:border-0 text-slate-600 hover:bg-slate-50 px-2 rounded-lg transition-colors">
                                            <span>{l.name}</span><span className="text-liab font-mono">{l.amount.toLocaleString()}</span>
                                        </div>
                                    ))
                                ) : <div className="text-xs text-slate-400 italic px-2">無負債</div>}
                            </div>
                        </div>
                    </div>

                     <div className="bg-white p-5 rounded-2xl border border-slate-100 card-shadow">
                        <div className="flex justify-between items-center mb-5">
                            <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icons.PieChart /> 損益表</h3>
                            <input type="month" value={reportMonth} onChange={(e) => setReportMonth(e.target.value)} className="text-xs border rounded-lg p-2 bg-slate-50 text-slate-600 font-medium" />
                        </div>
                        <div className="text-center py-6 bg-slate-50 rounded-2xl mb-6 border border-slate-100">
                            <span className="text-xs text-slate-400 block mb-2 uppercase tracking-wide font-bold">本月淨利</span>
                            <span className={`text-3xl font-bold font-mono ${isData.netIncome >= 0 ? 'text-asset' : 'text-liab'}`}>{isData.netIncome.toLocaleString()}</span>
                        </div>
                        <div className="grid grid-cols-2 gap-6 text-sm">
                            <div>
                                <h4 className="font-bold text-blue-700 mb-3 border-b border-blue-100 pb-2">收入: {isData.totalIncome.toLocaleString()}</h4>
                                {isData.incomeList.map(i => <div key={i.name} className="flex justify-between text-xs py-1.5 text-slate-600"><span>{i.name}</span><span className="text-asset font-mono">{i.amount.toLocaleString()}</span></div>)}
                            </div>
                            <div>
                                <h4 className="font-bold text-amber-700 mb-3 border-b border-amber-100 pb-2">支出: {isData.totalExpense.toLocaleString()}</h4>
                                {isData.expenseList.map(i => <div key={i.name} className="flex justify-between text-xs py-1.5 text-slate-600"><span>{i.name}</span><span className="text-liab font-mono">{i.amount.toLocaleString()}</span></div>)}
                            </div>
                        </div>
                    </div>
                </div>
            );

            const renderAccounts = () => {
                const sectionStyle = (key) => {
                    if (key === 'ASSETS' || key === 'INCOME') return { header: 'text-blue-700 bg-blue-50', icon: 'bg-blue-500 text-white' };
                    return { header: 'text-amber-700 bg-amber-50', icon: 'bg-amber-500 text-white' };
                };

                return (
                <div className="space-y-4 pb-28">
                     {['ASSETS', 'LIABILITIES', 'INCOME', 'EXPENSES'].map(key => (
                        <div key={key} className="bg-white rounded-2xl border border-slate-100 overflow-hidden card-shadow">
                            <div className={`p-4 border-b border-slate-100 flex justify-between items-center ${sectionStyle(key).header}`}>
                                <span className="font-bold text-sm tracking-wide">{key === 'ASSETS' ? '資產' : key === 'LIABILITIES' ? '負債' : key === 'INCOME' ? '收入' : '支出'}</span>
                                <div className="flex gap-2">
                                    <input type="text" placeholder="新增..." value={newAccountInputs[key]} onChange={e => setNewAccountInputs({...newAccountInputs, [key]: e.target.value})} className="text-xs p-1.5 border-none rounded-lg w-24 bg-white/70 shadow-sm focus:bg-white transition-all" />
                                    <button onClick={() => handleAddAccount(key)} className={`${sectionStyle(key).icon} px-2 rounded-lg text-xs shadow-sm active:scale-95 transition-transform`}><Icons.Plus /></button>
                                </div>
                            </div>
                            <div className="p-2 max-h-48 overflow-y-auto">
                                {categories[key].map(acc => (
                                    <div key={acc} className="flex justify-between items-center py-2.5 px-3 border-b last:border-0 border-slate-50 hover:bg-slate-50 rounded-lg transition-colors group">
                                        <span className="text-sm text-slate-600">{acc}</span>
                                        <button onClick={() => handleDeleteAccount(key, acc)} className="text-slate-300 hover:text-amber-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icons.X /></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                     ))}
                </div>
            )};
            
            const renderSettings = () => (
                <div className="space-y-6 pb-28">
                    <div className="bg-white p-5 rounded-2xl border border-slate-100 card-shadow">
                        <h3 className="font-bold text-slate-700 mb-5 flex items-center gap-2"><Icons.Wallet /> 期初餘額設定 (2023/01/01)</h3>
                        
                        <div className="space-y-6">
                            <div>
                                <h4 className="text-xs font-bold text-blue-700 bg-blue-50 p-2 rounded-lg mb-3 inline-block px-3">資產 (Assets)</h4>
                                <div className="space-y-3 pl-1">
                                    {categories.ASSETS.map(acc => (
                                        <div key={acc} className="flex justify-between items-center border-b border-slate-50 last:border-0 pb-2">
                                            <label className="text-xs text-slate-600 flex-1">{acc}</label>
                                            <input type="number" value={openingBalances[acc] !== undefined ? openingBalances[acc] : 0} onChange={e => setOpeningBalances({...openingBalances, [acc]: parseFloat(e.target.value) || 0})} className="border rounded-lg p-1.5 text-sm w-32 text-right font-mono bg-slate-50 focus:bg-white transition-colors" placeholder="0" />
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <h4 className="text-xs font-bold text-amber-700 bg-amber-50 p-2 rounded-lg mb-3 inline-block px-3">負債 (Liabilities)</h4>
                                <p className="text-[10px] text-slate-400 mb-2 px-1">* 請輸入負數表示欠款</p>
                                <div className="space-y-3 pl-1">
                                    {categories.LIABILITIES.map(acc => (
                                        <div key={acc} className="flex justify-between items-center border-b border-slate-50 last:border-0 pb-2">
                                            <label className="text-xs text-slate-600 flex-1">{acc}</label>
                                            <input type="number" value={openingBalances[acc] !== undefined ? openingBalances[acc] : 0} onChange={e => setOpeningBalances({...openingBalances, [acc]: parseFloat(e.target.value) || 0})} className="border rounded-lg p-1.5 text-sm w-32 text-right font-mono bg-slate-50 focus:bg-white text-amber-600 transition-colors" placeholder="0" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-5 rounded-2xl border border-slate-100 card-shadow">
                        <h3 className="font-bold text-slate-700 mb-5 flex items-center gap-2">
                            <Icons.Save /> 資料備份與還原
                        </h3>
                        
                        <div className="space-y-4">
                            <div className="space-y-2">
                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">匯出備份</h4>
                                <button onClick={exportToJSON} className="w-full flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition group">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-slate-700">下載完整備份檔 (.json)</span>
                                        <span className="text-xs text-slate-500/70">換手機或換網址時使用</span>
                                    </div>
                                    <span className="text-slate-500 bg-white p-2 rounded-full"><Icons.Download /></span>
                                </button>
                                
                                <button onClick={exportToCSV} className="w-full flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl hover:bg-slate-100 transition">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-slate-700">下載交易明細 (.csv)</span>
                                        <span className="text-xs text-slate-500">僅供 Excel 分析使用</span>
                                    </div>
                                    <span className="text-slate-400 bg-white p-2 rounded-full"><Icons.FileText /></span>
                                </button>
                            </div>

                            <div className="border-t border-slate-100 pt-5 space-y-2">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">資料匯入</h4>
                                </div>
                                
                                <input type="file" accept=".json" ref={fileInputRef} onChange={handleImportJSON} style={{ display: 'none' }} />
                                <button onClick={triggerFileInput} className="w-full flex items-center justify-between p-4 bg-amber-50 border border-amber-100 rounded-xl hover:bg-amber-100 transition group">
                                    <div className="flex flex-col items-start">
                                        <span className="text-sm font-bold text-amber-700 flex items-center gap-2">還原備份 (.json) <Icons.AlertTriangle className="w-3 h-3"/></span>
                                        <span className="text-xs text-amber-600/70">注意：將覆蓋現有資料</span>
                                    </div>
                                    <span className="text-amber-500 bg-white p-2 rounded-full"><Icons.Upload /></span>
                                </button>

                                <div className="pt-2">
                                    <div className="flex justify-between items-center mb-2 px-1">
                                        <span className="text-[10px] text-slate-400">匯入 Excel CSV (JE_*.csv)</span>
                                        <div className="flex items-center gap-2 text-[10px] text-slate-500 bg-slate-100 px-2 py-1 rounded-lg">
                                            <label className="flex items-center gap-1 cursor-pointer"><input type="radio" checked={isCsvUtf8} onChange={() => setIsCsvUtf8(true)} /> UTF-8</label>
                                            <label className="flex items-center gap-1 cursor-pointer"><input type="radio" checked={!isCsvUtf8} onChange={() => setIsCsvUtf8(false)} /> Big5</label>
                                        </div>
                                    </div>
                                    <input type="file" accept=".csv" multiple ref={csvInputRef} onChange={handleImportCSV} style={{ display: 'none' }} />
                                    <button onClick={triggerCsvInput} className="w-full flex items-center justify-between p-4 bg-emerald-50 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition">
                                        <div className="flex flex-col items-start">
                                            <span className="text-sm font-bold text-emerald-700">匯入舊版交易紀錄 (.csv)</span>
                                            <span className="text-xs text-emerald-600/70">支援多檔選取</span>
                                        </div>
                                        <span className="text-emerald-500 bg-white p-2 rounded-full"><Icons.FilePlus /></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen safe-area-bottom pb-20">
                    <div className="sticky top-0 z-20 bg-white/95 backdrop-blur-md border-b border-slate-100 px-4 py-3 shadow-sm">
                        <h1 className="text-lg font-bold text-center text-slate-700 tracking-tight">記帳簿 <span className="text-xs font-normal text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full ml-1">Lite</span></h1>
                    </div>

                    <div className="p-4 max-w-3xl mx-auto">
                        {activeTab === 'journal' && renderJournal()}
                        {activeTab === 'reports' && renderReports()}
                        {activeTab === 'accounts' && renderAccounts()}
                        {activeTab === 'settings' && renderSettings()}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-2 pb-6 safe-area-bottom flex justify-between items-center shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)] z-20">
                        <button onClick={() => setActiveTab('journal')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'journal' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className="p-1"><Icons.Plus /></div>
                            <span className="text-[10px]">記帳</span>
                        </button>
                        <button onClick={() => setActiveTab('reports')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'reports' ? 'tab-active' : 'tab-inactive'}`}>
                             <div className="p-1"><Icons.BookOpen /></div>
                            <span className="text-[10px]">報表</span>
                        </button>
                        <button onClick={() => setActiveTab('accounts')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'accounts' ? 'tab-active' : 'tab-inactive'}`}>
                             <div className="p-1"><Icons.List /></div>
                            <span className="text-[10px]">科目</span>
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex flex-col items-center gap-1 transition-colors ${activeTab === 'settings' ? 'tab-active' : 'tab-inactive'}`}>
                             <div className="p-1"><Icons.Settings /></div>
                            <span className="text-[10px]">設定</span>
                        </button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
